<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { height: 100vh; position: fixed; top: 0; left: 0; padding-top: 20px; background: #343a40; color: white; width: 250px; }
        .sidebar a { padding: 10px 20px; color: #adb5bd; text-decoration: none; display: block; }
        .sidebar a:hover, .sidebar a.active { background: #495057; color: white; }
        .main-content { margin-left: 250px; padding: 20px; }
        .card-hover:hover { transform: translateY(-2px); transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-badge { width: 100px; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="loginOverlay">
        <div class="card p-4 shadow-lg" style="width: 350px;">
            <h3 class="text-center mb-4"><i class="fas fa-lock text-primary me-2"></i>Admin Login</h3>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
                <div id="loginError" class="text-danger mt-2 text-center small d-none">Invalid password</div>
            </form>
        </div>
    </div>

    <div class="sidebar d-none" id="sidebar">
        <h4 class="text-center mb-4">Portfolio Admin</h4>
        <a href="#" class="active" onclick="switchTab('projects', event)"><i class="fas fa-project-diagram me-2"></i> Projects</a>
        <a href="#" onclick="switchTab('messages', event)"><i class="fas fa-envelope me-2"></i> Messages</a>
        <a href="#" class="mt-5 text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>

    <div class="main-content d-none" id="mainContent">
        <!-- Content injected by JS -->
        <h2 class="mb-4" id="pageTitle">Projects</h2>
        <div id="contentArea"></div>
    </div>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Check Auth on Load
        async function checkAuth() {
            try {
                const res = await fetch('/api/auth/me');
                if (res.ok) {
                    showDashboard();
                }
            } catch (e) { console.error(e); }
        }
        checkAuth();

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            if (res.ok) {
                showDashboard();
            } else {
                document.getElementById('loginError').classList.remove('d-none');
            }
        });

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            location.reload();
        }

        function showDashboard() {
            document.getElementById('loginOverlay').classList.add('d-none');
            document.getElementById('sidebar').classList.remove('d-none');
            document.getElementById('mainContent').classList.remove('d-none');
            loadProjects(); // Default view
        }

        function switchTab(tab, e) {
            if(e) {
                document.querySelectorAll('.sidebar a').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
            }
            if (tab === 'projects') {
                document.getElementById('pageTitle').innerText = 'Projects';
                loadProjects();
            } else {
                document.getElementById('pageTitle').innerText = 'Messages';
                loadMessages();
            }
        }

        async function loadProjects() {
            const res = await fetch('/api/projects');
            const projects = await res.json();
            const html = `
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center bg-white">
                        <h5 class="mb-0">Projects List</h5>
                        <button class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i> Add Project</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light"><tr><th>Title</th><th>Status</th><th>Likes</th><th>Actions</th></tr></thead>
                            <tbody>
                                ${projects.map(p => `
                                    <tr>
                                        <td>${p.title}</td>
                                        <td><span class="badge bg-${p.status === 'live' ? 'success' : 'warning'}">${p.status}</span></td>
                                        <td>${p.likes || 0}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            document.getElementById('contentArea').innerHTML = html;
        }

        async function loadMessages() {
            const res = await fetch('/api/messages');
            const messages = await res.json();
            const html = `
                 <div class="card shadow-sm">
                    <div class="card-header bg-white"><h5 class="mb-0">Inbox</h5></div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light"><tr><th>From</th><th>Subject</th><th>Date</th><th>Action</th></tr></thead>
                            <tbody>
                                ${messages.length ? messages.map(m => `
                                    <tr>
                                        <td><div>${m.name}</div><small class="text-muted">${m.email}</small></td>
                                        <td>${m.subject}</td>
                                        <td>${new Date(m.created_at).toLocaleDateString()}</td>
                                        <td><button class="btn btn-sm btn-outline-danger" onclick="deleteMessage(${m.id})"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4" class="text-center py-4">No messages found.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>`;
             document.getElementById('contentArea').innerHTML = html;
        }

        async function deleteMessage(id) {
            if(confirm('Delete this message?')) {
                await fetch('/api/messages/' + id, { method: 'DELETE' });
                loadMessages();
            }
        }
    </script>
</body>
</html>
